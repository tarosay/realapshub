(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();var L=Uint8Array,N=Uint16Array,Ot=Int32Array,kt=new L([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Mt=new L([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Xt=new L([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Et=function(a,t){for(var e=new N(31),i=0;i<31;++i)e[i]=t+=1<<a[i-1];for(var s=new Ot(e[30]),i=1;i<30;++i)for(var n=e[i];n<e[i+1];++n)s[n]=n-e[i]<<5|i;return{b:e,r:s}},It=Et(kt,2),St=It.b,Yt=It.r;St[28]=258,Yt[258]=28;var zt=Et(Mt,0),Wt=zt.b,rt=new N(32768);for(var g=0;g<32768;++g){var B=(g&43690)>>1|(g&21845)<<1;B=(B&52428)>>2|(B&13107)<<2,B=(B&61680)>>4|(B&3855)<<4,rt[g]=((B&65280)>>8|(B&255)<<8)>>1}var H=function(a,t,e){for(var i=a.length,s=0,n=new N(t);s<i;++s)a[s]&&++n[a[s]-1];var r=new N(t);for(s=1;s<t;++s)r[s]=r[s-1]+n[s-1]<<1;var l;if(e){l=new N(1<<t);var m=15-t;for(s=0;s<i;++s)if(a[s])for(var u=s<<4|a[s],c=t-a[s],o=r[a[s]-1]++<<c,h=o|(1<<c)-1;o<=h;++o)l[rt[o]>>m]=u}else for(l=new N(i),s=0;s<i;++s)a[s]&&(l[s]=rt[r[a[s]-1]++]>>15-a[s]);return l},q=new L(288);for(var g=0;g<144;++g)q[g]=8;for(var g=144;g<256;++g)q[g]=9;for(var g=256;g<280;++g)q[g]=7;for(var g=280;g<288;++g)q[g]=8;var Dt=new L(32);for(var g=0;g<32;++g)Dt[g]=5;var Nt=H(q,9,1),Ut=H(Dt,5,1),Z=function(a){for(var t=a[0],e=1;e<a.length;++e)a[e]>t&&(t=a[e]);return t},E=function(a,t,e){var i=t/8|0;return(a[i]|a[i+1]<<8)>>(t&7)&e},tt=function(a,t){var e=t/8|0;return(a[e]|a[e+1]<<8|a[e+2]<<16)>>(t&7)},Vt=function(a){return(a+7)/8|0},ht=function(a,t,e){return(t==null||t<0)&&(t=0),(e==null||e>a.length)&&(e=a.length),new L(a.subarray(t,e))},Ht=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],M=function(a,t,e){var i=new Error(t||Ht[a]);if(i.code=a,Error.captureStackTrace&&Error.captureStackTrace(i,M),!e)throw i;return i},qt=function(a,t,e,i){var s=a.length,n=i?i.length:0;if(!s||t.f&&!t.l)return e||new L(0);var r=!e,l=r||t.i!=2,m=t.i;r&&(e=new L(s*3));var u=function(gt){var dt=e.length;if(gt>dt){var _t=new L(Math.max(dt*2,gt));_t.set(e),e=_t}},c=t.f||0,o=t.p||0,h=t.b||0,f=t.l,_=t.d,v=t.m,p=t.n,O=s*8;do{if(!f){c=E(a,o,1);var U=E(a,o+1,3);if(o+=3,U)if(U==1)f=Nt,_=Ut,v=9,p=5;else if(U==2){var b=E(a,o,31)+257,F=E(a,o+10,15)+4,k=b+E(a,o+5,31)+1;o+=14;for(var R=new L(k),D=new L(19),x=0;x<F;++x)D[Xt[x]]=E(a,o+x*3,7);o+=F*3;for(var X=Z(D),Rt=(1<<X)-1,Tt=H(D,X,1),x=0;x<k;){var lt=Tt[E(a,o,Rt)];o+=lt&15;var w=lt>>4;if(w<16)R[x++]=w;else{var Y=0,$=0;for(w==16?($=3+E(a,o,3),o+=2,Y=R[x-1]):w==17?($=3+E(a,o,7),o+=3):w==18&&($=11+E(a,o,127),o+=7);$--;)R[x++]=Y}}var ct=R.subarray(0,b),T=R.subarray(b);v=Z(ct),p=Z(T),f=H(ct,v,1),_=H(T,p,1)}else M(1);else{var w=Vt(o)+4,A=a[w-4]|a[w-3]<<8,y=w+A;if(y>s){m&&M(0);break}l&&u(h+A),e.set(a.subarray(w,y),h),t.b=h+=A,t.p=o=y*8,t.f=c;continue}if(o>O){m&&M(0);break}}l&&u(h+131072);for(var Bt=(1<<v)-1,At=(1<<p)-1,j=o;;j=o){var Y=f[tt(a,o)&Bt],z=Y>>4;if(o+=Y&15,o>O){m&&M(0);break}if(Y||M(2),z<256)e[h++]=z;else if(z==256){j=o,f=null;break}else{var mt=z-254;if(z>264){var x=z-257,V=kt[x];mt=E(a,o,(1<<V)-1)+St[x],o+=V}var J=_[tt(a,o)&At],Q=J>>4;J||M(3),o+=J&15;var T=Wt[Q];if(Q>3){var V=Mt[Q];T+=tt(a,o)&(1<<V)-1,o+=V}if(o>O){m&&M(0);break}l&&u(h+131072);var ut=h+mt;if(h<T){var ft=n-T,Ft=Math.min(T,ut);for(ft+h<0&&M(3);h<Ft;++h)e[h]=i[ft+h]}for(;h<ut;++h)e[h]=e[h-T]}}t.l=f,t.p=j,t.b=h,t.f=c,f&&(c=1,t.m=v,t.d=_,t.n=p)}while(!c);return h!=e.length&&r?ht(e,0,h):e.subarray(0,h)},$t=new L(0),P=function(a,t){return a[t]|a[t+1]<<8},S=function(a,t){return(a[t]|a[t+1]<<8|a[t+2]<<16|a[t+3]<<24)>>>0},et=function(a,t){return S(a,t)+S(a,t+4)*4294967296};function Gt(a,t){return qt(a,{i:2},t&&t.out,t&&t.dictionary)}var ot=typeof TextDecoder<"u"&&new TextDecoder,Kt=0;try{ot.decode($t,{stream:!0}),Kt=1}catch{}var jt=function(a){for(var t="",e=0;;){var i=a[e++],s=(i>127)+(i>223)+(i>239);if(e+s>a.length)return{s:t,r:ht(a,e-1)};s?s==3?(i=((i&15)<<18|(a[e++]&63)<<12|(a[e++]&63)<<6|a[e++]&63)-65536,t+=String.fromCharCode(55296|i>>10,56320|i&1023)):s&1?t+=String.fromCharCode((i&31)<<6|a[e++]&63):t+=String.fromCharCode((i&15)<<12|(a[e++]&63)<<6|a[e++]&63):t+=String.fromCharCode(i)}};function Jt(a,t){if(t){for(var e="",i=0;i<a.length;i+=16384)e+=String.fromCharCode.apply(null,a.subarray(i,i+16384));return e}else{if(ot)return ot.decode(a);var s=jt(a),n=s.s,e=s.r;return e.length&&M(8),n}}var Qt=function(a,t){return t+30+P(a,t+26)+P(a,t+28)},Zt=function(a,t,e){var i=P(a,t+28),s=Jt(a.subarray(t+46,t+46+i),!(P(a,t+8)&2048)),n=t+46+i,r=S(a,t+20),l=e&&r==4294967295?te(a,n):[r,S(a,t+24),S(a,t+42)],m=l[0],u=l[1],c=l[2];return[P(a,t+10),m,u,s,n+P(a,t+30)+P(a,t+32),c]},te=function(a,t){for(;P(a,t)!=1;t+=4+P(a,t+2));return[et(a,t+12),et(a,t+4),et(a,t+20)]};function ee(a,t){for(var e={},i=a.length-22;S(a,i)!=101010256;--i)(!i||a.length-i>65558)&&M(13);var s=P(a,i+8);if(!s)return{};var n=S(a,i+16),r=n==4294967295||s==65535;if(r){var l=S(a,i-12);r=S(a,l)==101075792,r&&(s=S(a,l+32),n=S(a,l+48))}for(var m=0;m<s;++m){var u=Zt(a,n,r),c=u[0],o=u[1],h=u[2],f=u[3],_=u[4],v=u[5],p=Qt(a,v);n=_,c?c==8?e[f]=Gt(a.subarray(p,p+o),{out:new L(h)}):M(14,"unknown compression type "+c):e[f]=ht(a,p,p+o)}return e}class vt{static Load(t){const e=new TextDecoder("ascii");let i=0;function s(){let y=i;for(;i<t.length&&t[i]!==10;)i++;const b=e.decode(t.slice(y,i));return i++,b.trim()}const n=s(),r=n==="PF";if(!r&&n!=="Pf")throw new Error("Unsupported PFM format: "+n);const l=s(),[m,u]=l.split(" "),c=parseInt(m,10),o=parseInt(u,10);if(isNaN(c)||isNaN(o))throw new Error("Invalid size: "+l);const h=s(),f=parseFloat(h),_=Math.abs(f),v=f<0,p=r?3:1,O=c*o*p,U=new DataView(t.buffer,t.byteOffset+i,t.byteLength-i),w=new Float32Array(O);for(let y=0;y<O;y++)w[y]=U.getFloat32(y*4,v)*_;const A={format:n,scaleFactor:h,width:c,height:o};if(r){const y=new Float32Array(c*o),b=new Float32Array(c*o),F=new Float32Array(c*o);for(let k=0;k<o;k++){const R=o-1-k;for(let D=0;D<c;D++){const x=R*c+D,X=k*c+D;y[X]=w[x*3+0],b[X]=w[x*3+1],F[X]=w[x*3+2]}}A.rgb=[y,b,F]}else{let y=new Float32Array(c*o);for(let b=0;b<o;b++){const F=o-1-b;for(let k=0;k<c;k++){const R=F*c+k,D=b*c+k;y[D]=w[R]}}A.grayscale=y}return A}}class ie{constructor(t,e,i){if(this._width=0,this._height=0,t.length!=e*i)throw new Error("invalid argument. data length must be 'width * height' size.");this._data=t,this._width=e,this._height=i}getValue(t,e){return this._data[e*this._width+t]}get values(){return this._data}get width(){return this._width}get height(){return this._height}}class d{constructor(t=0,e=0){this._empty=!0,this._x=t,this._y=e,this._empty=!1}get x(){return this._x}set x(t){this._x=t,this._empty=!1}get y(){return this._y}set y(t){this._y=t,this._empty=!1}get isEmpty(){return this._empty}}class se{constructor(){this._visible=!0,this._tipsVisible=!0,this._text="",this._point=new d,this._location=new d,this._pointerDownLocation=new d,this._clickListeners=[],this.onFinderPointerDown=t=>{this._pointerDownLocation=new d(t.offsetX,t.offsetY),t.stopPropagation(),this._finderElement.addEventListener("pointermove",this.onFinderPointerMove),this._finderElement.addEventListener("pointerup",this.onFinderPointerUp)},this.onFinderPointerMove=t=>{},this.onFinderPointerUp=t=>{this._pointerDownLocation.x==t.offsetX&&this._pointerDownLocation.y==t.offsetY&&this.emitClick(t),this._finderElement.removeEventListener("pointermove",this.onFinderPointerMove),this._finderElement.removeEventListener("pointerup",this.onFinderPointerUp)},this._element=this.createElement(),this._tipsElement=this._element.querySelector(".tips"),this._finderElement=this._element.querySelector(".finder")}createElement(){const t=document.createElement("div");t.classList.add("marker");const e=document.createElement("div");e.classList.add("finder"),e.addEventListener("pointerdown",this.onFinderPointerDown);const i=document.createElement("div");return i.classList.add("tips"),t.appendChild(e),t.appendChild(i),t}get imageCoord(){return this._point}set imageCoord(t){this._point=t}get text(){return this._text}set text(t){this._text=t,this._tipsElement.textContent=t}get location(){return this._location}set location(t){this._location=t,this._element.style.left=t.x+"px",this._element.style.top=t.y+"px"}get visible(){return this._visible}set visible(t){this._visible=t,this._element.style.display=t?"":"none"}get tipsVisible(){return this._tipsVisible}set tipsVisible(t){this._tipsVisible=t,this._tipsElement.style.display=t?"":"none"}emitClick(t){for(let e=0;e<this._clickListeners.length;e++)this._clickListeners[e](this,t)}onClick(t){this._clickListeners.push(t)}offClick(t){const e=this._clickListeners.indexOf(t);e!=-1&&this._clickListeners.splice(e,1)}get element(){return this._element}}function ae(a){switch(a){case"picture":return"元データ";case"cof":return"測光色オーバーフロー";case"lm":return"輝度";case"lmc":return"輝度比";default:return"不明"}}function it(a,t,e){return Math.max(t,Math.min(e,a))}const ne=80,re=120,st=20,I=5,C=.5;class pt{constructor(){this._min=0,this._max=0,this._visible=!0,this._element=this.createElement(),this._canvas=this._element.querySelector(".drawarea"),this._ctx=this._canvas.getContext("2d")}createElement(){const t=document.createElement("div");t.classList.add("scalebar");const e=document.createElement("canvas");return e.classList.add("drawarea"),e.width=ne,e.height=re,t.appendChild(e),t}drawLmScale(t,e){const s=this._ctx;s.clearRect(0,0,this._canvas.width,this._canvas.height);const n=st,r=this._canvas.height-I*2;for(let h=0;h<r;h++){const f=1-h/r*2,_=Math.floor(it(1.5-Math.abs(2*f+1),.15,.85)*255),v=Math.floor(it(1.5-Math.abs(2*f),.15,.85)*255),p=Math.floor(it(1.5-Math.abs(2*f-1),.15,.85)*255);s.fillStyle=`rgb(${_} ${v} ${p})`,s.fillRect(0+C,I+(r-h)+C,n,1)}s.strokeRect(0+C,I+C,n,r),s.fillStyle="black";const l=Math.log10(t),u=(Math.log10(e)-l)/5;let c=[t];for(let h=1;h<5;h++)c.push(Math.pow(10,l+u*h));c.push(e);const o=r/5;for(let h=0;h<c.length;h++){const f=r+I-h*o+C,_=h==0||h==c.length-1?8:5;s.beginPath(),s.moveTo(n,f),s.lineTo(n+_,f),s.stroke();const v=c[h];let p=0;1<=v?p=0:p=Math.floor(Math.abs(Math.log10(v))),s.fillText(c[h].toFixed(p),n+10,f+3)}}drawLmcScale(){const t=this._ctx;t.clearRect(0,0,this._canvas.width,this._canvas.height);const e=["0","1/10","1/3","1/2","2","3","10","∞"],i=["#80f","#00f","#0ff","#f5f5f5","#ff0","#f80","#f00"],s=st,n=this._canvas.height-I*2,r=n/i.length;for(let l=0;l<i.length;l++){let m=n+I-l*r;t.fillStyle=i[l],t.fillRect(0+C,m-r+C,s,r+C)}t.fillStyle="black";for(let l=0;l<=e.length;l++){let m=n+I-l*r;const u=l==0||l==e.length-1?8:5;t.beginPath(),t.moveTo(s,m+C),t.lineTo(s+u,m+C),t.stroke(),t.closePath();const c=e[l];t.fillText(c,s+10,m+3+C)}t.strokeRect(0+C,I+C,s,n)}drawLmcScale2(){const t=this._ctx;t.clearRect(0,0,this._canvas.width,this._canvas.height);const e=[1e-4,1/10,1/3,1/2,2,3,10,20],i=["0","1/10","1/3","1/2","2","3","10","∞"],s=st,n=this._canvas.height-I*2;t.font=t.font.replace(/\d+px/,"10px");const r=Math.log10(e[e.length-1]),l=Math.log10(e[0]),m=r-l,u=n/m;for(let h=0;h<e.length;h++){let f=c(e[h]);h==0&&f--;const _=h==0||h==e.length-1?8:5;t.beginPath(),t.moveTo(0,f),t.lineTo(_,f),t.stroke();const v=i[h];t.fillText(v,s+10,f+3)}function c(h){let f=h===0?0:Math.log10(h);return Math.round(I+(r-f)*u)+C}const o=["#80f","#00f","#0ff","#f5f5f5","#ff0","#f80","#f00"];for(let h=0;h<e.length-1;h++){let f=(r-Math.log10(e[h]))*u,_=(r-Math.log10(e[h+1]))*u;const v=f-_;t.fillStyle=o[h],t.fillRect(0,_,s,v)}t.strokeRect(0+C,I+C,s,n)}get visible(){return this._visible}set visible(t){this._visible=t,this._element.style.display=t?"":"none"}get element(){return this._element}}class oe{constructor(t){this._listeners=[],this._visible=!0,this._imageTypes=t,this._element=this.createElement(t)}createElement(t){const e=document.createElement("select");e.className="imageselector";for(let i=0;i<t.length;i++){const s=document.createElement("option");s.textContent=ae(t[i]),e.appendChild(s)}return e.addEventListener("change",i=>{this.emitChanged(i)}),e}onChanged(t){this._listeners.push(t)}emitChanged(t){for(const e of this._listeners)e(t)}get visible(){return this._visible}set visible(t){this._visible=t,this._element.style.display=t?"":"none"}get element(){return this._element}get selectedImageType(){return this._imageTypes[this._element.selectedIndex]}set selectedImageType(t){this._element.selectedIndex=this._imageTypes.indexOf(t)}}class wt{constructor(t=0,e=0,i=0,s=0){this.x=t,this.y=e,this.width=i,this.height=s}get left(){return this.x}get top(){return this.y}get right(){return this.x+this.width}get bottom(){return this.y+this.height}get location(){return new d(this.x,this.y)}set location(t){this.x=t.x,this.y=t.y}get isEmpty(){return this.x===0&&this.y===0&&this.width===0&&this.height===0}}class Pt{constructor(){this._width=0,this._height=0,this._aspect=0,this._bitmap=null,this._scale=1,this._eye={x:.5,y:.5},this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._ctx.imageSmoothingEnabled=!1}getImageData(){return this._ctx.getImageData(0,0,this._canvas.width,this._canvas.height)}setImageData(t){this._ctx.putImageData(t,0,0)}drawImage(t,e){this.clear(),t!=null&&this._ctx.drawImage(t,e.x,e.y,e.width,e.height)}setSize(t,e){this._canvas.width=this._width=t,this._canvas.height=this._height=e,this._aspect=this._width/this._height}get image(){return this._bitmap}set image(t){this._bitmap=t}get scale(){return this._scale}set scale(t){this._scale=Math.max(t,1)}clear(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height)}get element(){return this._canvas}}class he extends Pt{constructor(){super(),this.element.classList.add("backcanvas")}}class le{constructor(){this._markers=[],this._container=this.createElement()}createElement(){const t=document.createElement("div");return t.classList.add("markercontainer"),t}add(t){this._markers.push(t),this._container.appendChild(t.element)}remove(t){const e=this._markers.indexOf(t);e!=-1&&(this._container.removeChild(t.element),this._markers.splice(e,1))}clear(){this._markers.length=0,this._container.innerHTML=""}get element(){return this._container}get markers(){return this._markers}}class ce extends Pt{constructor(){super(),this.isDrawing=!1,this.lastX=0,this.lastY=0,this.isClearMode=!1,this.lineWidth=4,this.stuckDepth=10,this.undoStuck=[],this.redoStuck=[],this.scaleFactor={width:1,height:1},this.getPos=t=>{const e=this.element.getBoundingClientRect(),i={x:0,y:0};return t instanceof TouchEvent?(i.x=t.touches[0].clientX-e.left,i.y=t.touches[0].clientY-e.top):(i.x=t.clientX-e.left,i.y=t.clientY-e.top),i.x=i.x*this.scaleFactor.width,i.y=i.y*this.scaleFactor.height,i},this.startDraw=t=>{t.preventDefault(),this.isDrawing=!0,this.updateStrokeStyle();const e=this.getPos(t);this.lastX=e.x,this.lastY=e.y,this.storeBuffer()},this.draw=t=>{if(!this.isDrawing)return;const e=this.getPos(t);this._ctx.beginPath(),this._ctx.moveTo(this.lastX,this.lastY),this._ctx.lineTo(e.x,e.y),this._ctx.stroke(),this._ctx.beginPath(),this._ctx.arc(e.x,e.y,this._ctx.lineWidth/2,0,Math.PI*2),this._ctx.fill(),this._ctx.beginPath(),this._ctx.moveTo(e.x,e.y),this.lastX=e.x,this.lastY=e.y},this.endDraw=()=>{this.isDrawing=!1},this.element.classList.add("frontcanvas"),this.initEvents()}initEvents(){this._canvas.addEventListener("pointerdown",this.startDraw),document.addEventListener("pointermove",this.draw),document.addEventListener("pointerup",this.endDraw),document.addEventListener("pointerleave",this.endDraw)}updateStrokeStyle(){this._ctx.lineWidth=this.lineWidth,this._ctx.globalCompositeOperation=this.isClearMode?"destination-out":"source-over",this._ctx.strokeStyle="white",this._ctx.fillStyle="white"}setLineWidth(t){this.lineWidth=t,this.updateStrokeStyle()}setEraserMode(t){this.isClearMode=t,this.updateStrokeStyle()}clearCanvas(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height)}getMask(t,e){const i=new Array(t*e),s=document.createElement("canvas");s.width=t,s.height=e;const n=s.getContext("2d");n?.drawImage(this._canvas,0,0,s.width,s.height);const r=n?.getImageData(0,0,s.width,s.height).data;for(let l=0;l<i.length;l++){const m=l*4+3;i[l]=r[m]>0}return i}undo(){this.undoStuck.length!=0&&(this.redoStuck.push(this.getImageData()),this.setImageData(this.undoStuck.pop()))}redo(){this.redoStuck.length!=0&&(this.undoStuck.push(this.getImageData()),this.setImageData(this.redoStuck.pop()))}reset(){this.redoStuck=[],this.undoStuck=[],this.clearCanvas()}storeBuffer(){this.undoStuck.push(this.getImageData()),this.redoStuck=[]}}const at=1,yt=20;class me{constructor(){this._width=0,this._height=0,this._image=null,this._scale=1,this._focusPoint=new d(.5,.5),this._imageRect=new wt,this._mouseDown=!1,this._downOffsetX=0,this._downOffsetY=0,this._imageRectX=0,this._imageRectY=0,this._pointerDownListeners=[],this._clickListeners=[],this.paintMode="brush",this.onPointerDown=t=>{this._element.setPointerCapture(t.pointerId),this._mouseDown=!0,this._downOffsetX=t.offsetX,this._downOffsetY=t.offsetY,this._imageRectX=this._imageRect.x,this._imageRectY=this._imageRect.y,this.emitPointerDown(t),this.element.addEventListener("pointermove",this.onPointerMove),this.element.addEventListener("pointerup",this.onPointerUp)},this.onPointerMove=t=>{if(!this._mouseDown)return;const e=t.offsetX-this._downOffsetX,i=t.offsetY-this._downOffsetY;this._imageRect.location=new d(this._imageRectX+e,this._imageRectY+i),this._imageRect.location=this.calibrateImageLocation(this._imageRect),this.updateMarkersPosition(),this.redraw()},this.onPointerUp=t=>{this._element.releasePointerCapture(t.pointerId),this._mouseDown&&(this._mouseDown=!1,this.redraw(),t.offsetX==this._downOffsetX&&t.offsetY==this._downOffsetY&&this.emitClick(t),this.element.removeEventListener("pointermove",this.onPointerMove),this.element.removeEventListener("pointerup",this.onPointerUp))},this.onMouseWheel=t=>{t.preventDefault(),t.deltaY<0?this.scaleAt(this.scale+.5,t.offsetX,t.offsetY):this.scaleAt(this.scale-.5,t.offsetX,t.offsetY)},this._element=document.createElement("div"),this._element.classList.add("lumimaplitecanvas"),this._backCanvas=new he,this._frontCanvas=new ce,this._markerContainer=new le,this._element.appendChild(this._backCanvas.element),this._element.appendChild(this._frontCanvas.element),this._element.appendChild(this._markerContainer.element),this._resizeObserver=new ResizeObserver(t=>{for(const e of t)if(e.target==this._element){const i=this._element.getBoundingClientRect();this.setSize(i.width,i.height)}}),this.element.addEventListener("pointerdown",this.onPointerDown),this.element.addEventListener("wheel",this.onMouseWheel)}setSize(t,e){this._width=t,this._height=e,this._frontCanvas.setSize(t,e),this._backCanvas.setSize(t,e),this._image&&(this._imageRect=this.getScaledImageRect(this._image,this._scale,this._focusPoint))}set image(t){this._image=t,this._image==null?this._backCanvas.clear():this.redraw()}get image(){return this._image}clear(){this._backCanvas.clear(),this._frontCanvas.clear(),this._markerContainer.clear(),this.resetPosition()}get scale(){return this._scale}set scale(t){this._scale=Math.max(at,Math.min(t,yt)),this._backCanvas.scale=this._scale,this._frontCanvas.scale=this._scale,this._image!=null&&(this._imageRect=this.getScaledImageRect(this._image,this._scale,this._focusPoint),this._backCanvas.drawImage(this._image,this._imageRect))}scaleAt(t,e,i){if(this._image===null)return;const s=this._imageRect;if(e<s.x||s.right<e||i<s.y||s.bottom<i)return;if(t=Math.max(at,Math.min(t,yt)),t===at){this.resetPosition(),this.redraw(),this.updateMarkersPosition();return}const n={x:(e-s.x)/s.width,y:(i-s.y)/s.height},r=this.getScaledImageRect(this._image,t,this._focusPoint);r.location=new d(e-r.width*n.x,i-r.height*n.y),r.location=this.calibrateImageLocation(r),this._imageRect=r,this._scale=t,this.updateFocusPoint(),this.redraw(),this.updateMarkersPosition()}redraw(){this._image!=null&&(this._imageRect.isEmpty&&(this._imageRect=this.getScaledImageRect(this._image,this._scale,this._focusPoint)),this._backCanvas.drawImage(this._image,this._imageRect))}getScaledImageRect(t,e,i){const n=Math.min(this._width/t.width,this._height/t.height)*e,r=t.width*n,l=t.height*n,m=new d(this._width/2,this._height/2),u=new d(r*i.x,l*i.y),c=m.x-u.x,o=m.y-u.y;return new wt(c,o,r,l)}calibrateImageLocation(t){let e=t.x,i=t.y;return this._width<=Math.round(t.width)?0<t.x?e=0:t.right<this._width&&(e=this._width-t.width):e=this._width/2-t.width/2,this._height<=Math.round(t.height)?0<t.y?i=0:t.bottom<this._height&&(i=this._height-t.height):i=this._height/2-t.height/2,new d(e,i)}getImagePointAtClientCenter(t,e){return new d(this._width/2+t,this._height/2+e)}getFocusPoint(t){const e=new d(this._width/2+t.x,this._height/2+t.y);return new d(e.x/t.width,e.y/t.height)}clientCoordToImageCoord(t,e){if(this._image===null)return new d;const i=new d(t-this._imageRect.x,e-this._imageRect.y),s=new d(i.x/this._imageRect.width,i.y/this._imageRect.height);return new d(Math.floor(s.x*this._image.width),Math.floor(s.y*this._image.height))}imageCoordToClientCoord(t){if(this._image===null)return new d;const e=new d((t.x+.5)/this._image.width,(t.y+.5)/this._image.height),i=new d(this._imageRect.width*e.x,this._imageRect.height*e.y);return new d(this._imageRect.x+i.x,this._imageRect.y+i.y)}updateFocusPoint(){this._image!=null&&(this._focusPoint=this.getFocusPoint(this._imageRect))}updateMarkersPosition(){for(let t=0;t<this._markerContainer.markers.length;t++){const e=this._markerContainer.markers[t],i=this.imageCoordToClientCoord(e.imageCoord);e.location=i,e.visible=!(i.x<0||this._width<i.x||i.y<0||this._height<i.y)}}resetPosition(){this._scale=1,this._focusPoint=new d(.5,.5),this._image&&(this._imageRect=this.getScaledImageRect(this._image,this._scale,this._focusPoint))}emitPointerDown(t){if(this._pointerDownListeners.length!=0)for(let e=0;e<this._pointerDownListeners.length;e++)this._pointerDownListeners[e](t)}emitClick(t){if(this._clickListeners.length!=0)for(let e=0;e<this._clickListeners.length;e++)this._clickListeners[e](t)}pointerDown(t){this._pointerDownListeners.push(t)}click(t){this._clickListeners.push(t)}addMarker(t){this._markerContainer.add(t)}removeMarker(t){this._markerContainer.remove(t)}get markers(){return this._markerContainer.markers}get element(){return this._element}}const xt=[255,0,0,255],Ct=[0,0,255,255],ue=[255,255,0,255],fe=[255,127,0,255],ge=[0,255,255,255],de=[245,245,245,255],_e=[97,77,157,255],nt=[0,0,0,0],G=34028234663852886e22;function K(a,t,e){return Math.max(t,Math.min(e,a))}class W{static async createImageBitmap(t){return createImageBitmap(t)}static async createLMImageBitmap(t,e,i){const s=new Uint8ClampedArray(t.values.length*4);let n,r=Math.log10(e),m=Math.log10(i)-r;for(let u=0;u<t.values.length;u++){let c=t.values[u];if(c===-G)n=nt;else if(c===G)n=nt;else{const h=K(c,e,i);c===0&&(c=1e-6);const _=1-(Math.log10(h)-r)/m*2;n=[K(1.5-Math.abs(2*_+1),.15,.85)*255,K(1.5-Math.abs(2*_),.15,.85)*255,K(1.5-Math.abs(2*_-1),.15,.85)*255,255]}const o=u*4;s[o+0]=Math.round(n[0]),s[o+1]=Math.round(n[1]),s[o+2]=Math.round(n[2]),s[o+3]=n[3]}return await this.createImageBitmapWithCanvas(s,t.width,t.height)}static async createLMContrastImageBitmap(t,e){const i=new Uint8ClampedArray(t.values.length*4);let s;for(let n=0;n<t.values.length;n++){let r=t.values[n]/e;r>=10?s=xt:r>=3?s=fe:r>=2?s=ue:r>=.5?s=de:r>=.3333?s=ge:r>=.1?s=Ct:s=_e;const l=n*4;i[l+0]=s[0],i[l+1]=s[1],i[l+2]=s[2],i[l+3]=s[3]}return await this.createImageBitmapWithCanvas(i,t.width,t.height)}static async createColorOverflowImageBitmap(t){const e=new Uint8ClampedArray(t.values.length*4);let i=nt;for(let s=0;s<t.values.length;s++){let n=t.values[s];if(n===G)i=xt;else if(n===-G)i=Ct;else continue;const r=s*4;e[r+0]=i[0],e[r+1]=i[1],e[r+2]=i[2],e[r+3]=i[3]}return await this.createImageBitmapWithCanvas(e,t.width,t.height)}static async createImageBitmapWithCanvas(t,e,i){const s=document.createElement("canvas");s.width=e,s.height=i;const r=s.getContext("2d").getImageData(0,0,e,i);return r.data.set(t),await createImageBitmap(r)}static async add(t,e,i,s){const n=document.createElement("canvas");n.width=i,n.height=s;const r=n.getContext("2d");r.drawImage(t,0,0,i,s),r.drawImage(e,0,0,i,s);const l=r.getImageData(0,0,i,s);return await createImageBitmap(l)}}class bt{constructor(){this.lm={min:1e-5,max:1e5},this.lmc={baseLuminance:200}}}const Lt={FLOAT32_MAX:34028234663852886e22},ve=["picture","lm","lmc","cof"],pe="lm";class we{constructor(t){if(this._src=null,this._lumiData=null,this._imageDatas=new Map,this._baseLuminance=0,this._settings=new bt,this._scalebar=new pt,this.onImageSelectorChanged=e=>{const i=this._imageSelector.selectedImageType;this._imageDatas.has(i)&&this.changeImage(i)},this.onCanvasPointerDown=e=>{this._lumiData},this.onCanvasClick=e=>{if(e.button!=0||this._lumiData===null)return;const i=this._lumimapCanvas.clientCoordToImageCoord(e.offsetX,e.offsetY);if(i.x<0||this._lumiData.width<i.x||i.y<0||this._lumiData.height<i.y)return;const s=new se;s.location=new d(e.offsetX,e.offsetY),s.imageCoord=i,this.setMarkerTips(s),s.onClick(this.onMarkerClick),this._lumimapCanvas.addMarker(s)},this.onMarkerClick=(e,i)=>{i.button==0&&(e.offClick(this.onMarkerClick),this._lumimapCanvas.removeMarker(e))},t==null)throw new Error("Invalid argument.");this._container=t,this._scalebar=new pt,this._scalebar.visible=!1,this._imageSelector=new oe(ve),this._imageSelector.visible=!1,this._imageSelector.onChanged(this.onImageSelectorChanged),this._lumimapCanvas=new me,this._lumimapCanvas.click(this.onCanvasClick),this._resizeObserver=new ResizeObserver(e=>{for(const i of e)i.target==this._lumimapCanvas.element&&this.onControlResized()})}init(){this.reset(),this._container.appendChild(this._lumimapCanvas.element),this._container.appendChild(this._imageSelector.element),this._container.appendChild(this._scalebar.element),this.onControlResized()}async loadAsync(t){this.reset();try{let e;if(t.type=="image/x-portable-floatmap"||t.type=="image/x-pfm"||t.name.includes(".pfm"))e=vt.Load(new Uint8Array(await t.arrayBuffer()));else if(t.type=="image/jpeg")e=await this.fetchData(t);else throw new Error("unsupported file type.");this._lumiData=new ie(e.grayscale,e.width,e.height),await this.initializeImageBitmaps(t,this._lumiData),this.controlVisible=!0,this.changeImage(pe)}catch(e){e instanceof Error?console.error(e.message):console.error(e)}}async initializeImageBitmaps(t,e){const i=await W.createImageBitmap(t);this._imageDatas.set("picture",i),await this.updateLmImageBitmap(e,i,this._settings.lm.min,this._settings.lm.max),await this.updateLmcImageBitmap(e,this._settings.lmc.baseLuminance),await this.updateCofImageBitmap(e,i)}async fetchData(t){const e="https://ik1-127-70116.vs.sakura.ne.jp/markAnomaly",i=new FormData;return i.append("file",t),await fetch(e,{method:"POST",body:i}).then(s=>{if(!s.ok)throw new Error(`HTTP error! Status: ${s.status}`);return s.arrayBuffer()}).then(s=>ee(new Uint8Array(s))).then(s=>{for(const[n,r]of Object.entries(s))if(n.includes(".pfm"))return vt.Load(r);throw new Error("Could not found PFM File")}).catch(s=>{throw console.log(s),new Error("Failed to fetch file")})}reset(){this._lumimapCanvas.clear(),this._imageDatas.clear(),this._settings=new bt,this.controlVisible=!1}set controlVisible(t){this._imageSelector.visible=t,this._scalebar.visible=t}onControlResized(){const t=this._container.getBoundingClientRect();this._lumimapCanvas.setSize(t.width,t.height)}changeImage(t){switch(this._imageSelector.selectedImageType=t,this._lumimapCanvas.image=this._imageDatas.get(t),t){case"picture":case"cof":this._scalebar.visible=!1;break;default:switch(this._scalebar.visible=!0,t){case"lm":this._scalebar.drawLmScale(this._settings.lm.min,this._settings.lm.max);break;case"lmc":this._scalebar.drawLmcScale();break}break}this.updateAllMarkerTips()}updateAllMarkerTips(){for(let t=0;t<this._lumimapCanvas.markers.length;t++){const e=this._lumimapCanvas.markers[t];this.setMarkerTips(e)}}setMarkerTips(t){switch(this._imageSelector.selectedImageType){case"lm":this.setLmTips(t);break;case"lmc":this.setLmcTips(t);break;case"cof":default:this.hideMarkerTips(t);break}}setLmTips(t){const e=this._lumiData.getValue(t.imageCoord.x,t.imageCoord.y);let i=e.toFixed(2);Lt.FLOAT32_MAX<=e?i="+overflow":e<=-34028234663852886e22&&(i="-overflow"),t.text=i,t.tipsVisible=!0}setLmcTips(t){const e=this._lumiData.getValue(t.imageCoord.x,t.imageCoord.y);let i=(e/this._settings.lmc.baseLuminance).toFixed(2);Lt.FLOAT32_MAX<=e?i="+overflow":e<=-34028234663852886e22&&(i="-overflow"),t.text=i,t.tipsVisible=!0}hideMarkerTips(t){t.tipsVisible=!1}async updateLmImageBitmap(t,e,i,s){const r=await W.createLMImageBitmap(t,i,s),l=await W.add(e,r,r.width,r.height),m=this._imageDatas.get("lm");m&&m.close(),r.close(),this._imageDatas.set("lm",l)}async updateLmcImageBitmap(t,e){const s=await W.createLMContrastImageBitmap(t,e),n=this._imageDatas.get("lmc");n&&n.close(),this._imageDatas.set("lmc",s)}get lmcBaseLuminance(){return this._settings.lmc.baseLuminance}async setLmcBaseLuminance(t){!Number.isFinite(t)||t<=0||(this._settings.lmc.baseLuminance=t,this._lumiData&&(await this.updateLmcImageBitmap(this._lumiData,this._settings.lmc.baseLuminance),this._imageSelector.selectedImageType==="lmc"?this.changeImage("lmc"):this.updateAllMarkerTips()))}async updateCofImageBitmap(t,e){const s=await W.createColorOverflowImageBitmap(t),n=await W.add(e,s,s.width,s.height),r=this._imageDatas.get("cof");r&&r.close(),this._imageDatas.set("cof",n)}}document.addEventListener("DOMContentLoaded",function(){document.querySelector(".paintbox");const a=document.querySelector(".lumimaplite"),t=document.querySelector("#fileinput"),e=document.getElementById("lineWidthSlider"),i=document.getElementById("lineWidthValue"),s=document.getElementById("useEraser"),n=document.getElementById("baseLuminanceInput");document.getElementById("result");const r=new we(a);r.init(),n&&(n.value=r.lmcBaseLuminance.toString());function l(){const o=e.value;i.innerHTML=o}function m(){}if(e.addEventListener("input",l),s.addEventListener("change",m),n){const o=()=>{const h=Number(n.value);Number.isFinite(h)&&0<h?r.setLmcBaseLuminance(h):n.value=r.lmcBaseLuminance.toString()};n.addEventListener("change",o),n.addEventListener("blur",o)}t.addEventListener("change",async()=>{const o=t.files[0];o&&(await r.loadAsync(o),n&&(n.value=r.lmcBaseLuminance.toString()))}),document.querySelector("#calc").addEventListener("click",()=>{}),document.querySelector("#reset").addEventListener("click",()=>{})});
//# sourceMappingURL=index-CYm6qKUR.js.map
